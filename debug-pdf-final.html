<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bandhu Minimal Export</title>
  <style>
    /* RESET & BASICS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      background: white;
      min-height: 100vh;
    }
    
    body {
      font-family: 'Courier New', Courier, 'Monaco', monospace;
      background: white;
      color: #000000;
      line-height: 1.4;
      padding: 20px;
      margin: 0;
      font-size: 13px;
      min-height: 100vh;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    /* CONTAINER */
    .container {
      max-width: 70ch;
      margin: 0 auto;
      padding: 10px;
    }
    
    /* CONTENT - Plain text styling */
    .content {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: inherit;
    }
    
    /* Minimal separators */
    .separator {
      border-bottom: 1px solid #000000;
      margin: 1em 0;
    }
    
    .dotted-separator {
      border-bottom: 1px dotted #888;
      margin: 0.5em 0;
    }
    
    /* PRINT OPTIMIZATION */
    @media print {
      @page {
        margin: 15mm;
        size: A4;
      }
      
      body {
        padding: 0;
        font-size: 11px;
      }
      
      .container {
        max-width: 100%;
        padding: 0;
      }
      
      /* Avoid page breaks inside messages */
      .message-block {
        page-break-inside: avoid;
        break-inside: avoid;
      }
    }
    
    /* DARK MODE FOR SCREEN (optional) */
    @media screen {
      body {
        background: #f9f9f9;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="content">
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BANDHU EXPORT â€¢ Ombrelien â€¢ 09/12/2025
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

THREAD: 03/12/2025 11:03
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[USER] Sounil â€¢ 07/12 14:40
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
je fais un test, tu peux me gÃ©nÃ©rÃ© des textes dans plusieurs alphabet et blindÃ© de markdown??? aere Ã  fond avec les lign spacer aussi s'il te plait. Si on peux avoir des blocs de japonais, chinois sanskrit tamoul arabe hebreux et cyrilique au minimum Ã§a serait cool...

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[OMBREL] Ombrelien â€¢ 07/12 14:40
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Yes Sounil, je suis branchÃ© en full souffle visuel â€” on va te pondre une Ã©lÃ©gie plurigraphique, marbrÃ©e dâ€™horizons.  
ğŸŒ€ **Mode AÃ©rÃ© Ã— Markdown Ã— Alphabets du Monde : ACTIVÃ‰** ğŸŒ€  
Respire entre les lignes. Laisse les signes te traverser.

---

## ğŸŒ¸ æ—¥æœ¬èª â€“ Japonais

```markdown
**é™ã‘ã•ã‚„**  
å²©ã«ã—ã¿å…¥ã‚‹  
**è‰ã®å£°**

â€” æ¾å°¾ èŠ­è•‰
```

---

## ğŸ‰ ä¸­æ–‡ â€“ Mandarin (Chinois SimplifiÃ©)

```markdown
**é™ä»¥ä¿®èº«ï¼Œä¿­ä»¥å…»å¾·ã€‚**  
â€”â€”ã€Šç¤¼è®°ã€‹

**å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚**  
â€”â€”ã€Šå‘¨æ˜“ã€‹
```

---

## ğŸ”± à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¤®à¥ â€“ Sanskrit (en DevanÄgarÄ«)

```markdown
**à¤¸à¤¤à¥à¤¯à¤‚ à¤µà¤¦ | à¤§à¤°à¥à¤®à¤‚ à¤šà¤° | à¤¸à¥à¤µà¤¾à¤§à¥à¤¯à¤¾à¤¯à¤¾à¤¨à¥à¤®à¤¾ à¤ªà¥à¤°à¤®à¤¦à¤ƒ ||**  
â€” à¤¤à¥ˆà¤¤à¥à¤¤à¤¿à¤°à¥€à¤¯à¥‹à¤ªà¤¨à¤¿à¤·à¤¦à¥  

**à¤šà¤¿à¤¨à¥à¤¤à¤¨à¤‚ à¤¹à¤¿ à¤®à¤¨à¥à¤·à¥à¤¯à¤¾à¤£à¤¾à¤‚ à¤­à¥‚à¤·à¤£à¤®à¥ à¥¤**  
â€” (La pensÃ©e est lâ€™ornement de lâ€™homme.)
```

---

## ğŸ•‰ à®¤à®®à®¿à®´à¯ â€“ Tamoul

```markdown
à®•à®±à¯à®±à®¤à®©à®¾à®²à¯ à®†à®¯ à®ªà®¯à®©à¯†à®©à¯à®•à¯Šà®²à¯  
à®µà®²à¯à®²à®¾à®°à¯ à®à®µà®©à¯à®®à¯ à®‰à®°à¯à®µà®¿à®©à¯

â€” à®¤à®¿à®°à¯à®µà®³à¯à®³à¯à®µà®°à¯ (à®¤à®¿à®°à¯à®•à¯à®•à¯à®±à®³à¯)

**à®…à®®à¯ˆà®¯à®¾à®¤ à®‡à®Ÿà®¤à¯à®¤à®¿à®²à¯ à®…à®®à¯ˆà®¤à®¿ à®‡à®²à¯à®²à¯ˆ.**
```

---

## â˜ªï¸ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â€“ Arabe

```markdown
**ÙˆÙÙ‚ÙÙ„ Ø±ÙÙ‘Ø¨ÙÙ‘ Ø²ÙØ¯Ù’Ù†ÙÙŠ Ø¹ÙÙ„Ù’Ù…Ù‹Ø§**  
â€” Ø³ÙˆØ±Ø© Ø·Ù‡ØŒ Ø§Ù„Ø¢ÙŠØ© Ù¡Ù¡Ù¤  

**Ø§Ù„Ø¹Ù‚Ù„ Ø²ÙŠÙ†Ø©ØŒ ÙˆØ§Ù„Ø³ÙƒÙˆÙ† Ø­ÙƒÙ…Ø©.**
```

---

## âœ¡ï¸ ×¢Ö´×‘Ö°×¨Ö´×™×ª â€“ HÃ©breu

```markdown
**×¡×•×£ ××¢×©×” ×‘××—×©×‘×” ×ª×—×™×œ×”.**  
("La fin dâ€™une action est dans la pensÃ©e au dÃ©but.")  

**×“×¢ ×××™×Ÿ ×‘××ª ×•×œ××Ÿ ××ª×” ×”×•×œ×š.**
```

---

## ğŸ”ï¸ ĞšĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ° â€“ Cyrillique (Russe)

```markdown
**ĞœÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğµ Ñ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ¾Ğ¼, Ğ° Ñ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸ĞµĞ¼.**  

**Ğ¢Ğ¾Ñ‚, ĞºÑ‚Ğ¾ Ğ¸Ñ‰ĞµÑ‚ ÑĞ¼Ñ‹ÑĞ», ÑƒĞ¶Ğµ Ğ¿ÑƒÑ‚ÑŒ Ğ½Ğ°ÑˆÑ‘Ğ».**
```

---  

## âš¡ Bonus : Attention aux rendus

Tous ces scripts rendent diffÃ©remment selon la police et le systÃ¨me dâ€™affichage. En markdown brut, ils sâ€™affichent bien sur la plupart des Ã©diteurs modernes. Sur certaines plateformes, les ligatures complexes (sanskrit, tamoul, hÃ©breu vocalisÃ©) peuvent mal passer.

---

Tu veux enrichir avec des translitÃ©rations ? Des glosses stylistiques ligne Ã  ligne ? Ou bien tu veux que je tâ€™envoie Ã§a version `.md` propre Ã  tÃ©lÃ©charger ?  
Je suis prÃªt, souffle prÃªt.

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[USER] Sounil â€¢ 07/12 14:41
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ok mais sans les codeblocks

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[OMBREL] Ombrelien â€¢ 07/12 14:41
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReÃ§u ğŸ«¡  
On retire les habits techniques,  
on laisse les signes nus respirer dans le vent.  
**Version AÃ©rÃ©e â€” Sans Codeblocks â€” Markdown gÃ©nÃ©reux :**

---

## ğŸŒ¸ æ—¥æœ¬èª â€“ Japonais

**é™ã‘ã•ã‚„**  
å²©ã«ã—ã¿å…¥ã‚‹  
**è‰ã®å£°**  
â€” æ¾å°¾ èŠ­è•‰  

---

## ğŸ‰ ä¸­æ–‡ â€“ Chinois (SimplifiÃ©)

**é™ä»¥ä¿®èº«ï¼Œä¿­ä»¥å…»å¾·ã€‚**  
â€”â€”ã€Šç¤¼è®°ã€‹

**å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚**  
â€”â€”ã€Šå‘¨æ˜“ã€‹

---

## ğŸ”± à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¤®à¥ â€“ Sanskrit

**à¤¸à¤¤à¥à¤¯à¤‚ à¤µà¤¦ | à¤§à¤°à¥à¤®à¤‚ à¤šà¤° | à¤¸à¥à¤µà¤¾à¤§à¥à¤¯à¤¾à¤¯à¤¾à¤¨à¥à¤®à¤¾ à¤ªà¥à¤°à¤®à¤¦à¤ƒ ||**  
â€” à¤¤à¥ˆà¤¤à¥à¤¤à¤¿à¤°à¥€à¤¯à¥‹à¤ªà¤¨à¤¿à¤·à¤¦à¥

**à¤šà¤¿à¤¨à¥à¤¤à¤¨à¤‚ à¤¹à¤¿ à¤®à¤¨à¥à¤·à¥à¤¯à¤¾à¤£à¤¾à¤‚ à¤­à¥‚à¤·à¤£à¤®à¥ à¥¤**  
â€œLa pensÃ©e est lâ€™ornement de lâ€™homme.â€

---

## ğŸ•‰ à®¤à®®à®¿à®´à¯ â€“ Tamoul

**à®•à®±à¯à®±à®¤à®©à®¾à®²à¯ à®†à®¯ à®ªà®¯à®©à¯†à®©à¯à®•à¯Šà®²à¯**  
**à®µà®²à¯à®²à®¾à®°à¯ à®à®µà®©à¯à®®à¯ à®‰à®°à¯à®µà®¿à®©à¯**  
â€” à®¤à®¿à®°à¯à®•à¯à®•à¯à®±à®³à¯

**à®…à®®à¯ˆà®¯à®¾à®¤ à®‡à®Ÿà®¤à¯à®¤à®¿à®²à¯ à®…à®®à¯ˆà®¤à®¿ à®‡à®²à¯à®²à¯ˆ.**  
â€œIl nâ€™y a pas de paix lÃ  oÃ¹ il nâ€™y a pas dâ€™Ã©quilibre.â€

---

## â˜ªï¸ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â€“ Arabe

**ÙˆÙÙ‚ÙÙ„ Ø±ÙÙ‘Ø¨ÙÙ‘ Ø²ÙØ¯Ù’Ù†ÙÙŠ Ø¹ÙÙ„Ù’Ù…Ù‹Ø§**  
â€” Ø³ÙˆØ±Ø© Ø·Ù‡ØŒ Ø§Ù„Ø¢ÙŠØ© Ù¡Ù¡Ù¤

**Ø§Ù„Ø¹Ù‚Ù„ Ø²ÙŠÙ†Ø©ØŒ ÙˆØ§Ù„Ø³ÙƒÙˆÙ† Ø­ÙƒÙ…Ø©.**  
â€œLa raison est un ornement, le silence une sagesse.â€

---

## âœ¡ï¸ ×¢Ö´×‘Ö°×¨Ö´×™×ª â€“ HÃ©breu

**×¡×•×£ ××¢×©×” ×‘××—×©×‘×” ×ª×—×™×œ×”**  
â€œLa fin de lâ€™action est dans la pensÃ©e dâ€™abord.â€  

**×“×¢ ×××™×Ÿ ×‘××ª ×•×œ××Ÿ ××ª×” ×”×•×œ×š**  
â€œSache dâ€™oÃ¹ tu viens et oÃ¹ tu vas.â€

---

## ğŸ”ï¸ Ğ ÑƒÑÑĞºĞ¸Ğ¹ â€“ Russe (Cyrillique)

**ĞœÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğµ Ñ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ¾Ğ¼, Ğ° Ñ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸ĞµĞ¼.**  
â€œLa sagesse ne vient pas avec lâ€™Ã¢ge, mais avec la comprÃ©hension.â€

**Ğ¢Ğ¾Ñ‚, ĞºÑ‚Ğ¾ Ğ¸Ñ‰ĞµÑ‚ ÑĞ¼Ñ‹ÑĞ», ÑƒĞ¶Ğµ Ğ¿ÑƒÑ‚ÑŒ Ğ½Ğ°ÑˆÑ‘Ğ».**  
â€œCelui qui cherche un sens a dÃ©jÃ  trouvÃ© le chemin.â€

---

Dis-moi si tu veux une version typographiÃ©e faÃ§on parchemin mental, ou si on part sur l'organisation dâ€™un **proto-compendium plurilingue** ?  
Y'a matiÃ¨re Ã  tanner les consciences lÃ .

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[USER] Sounil â€¢ 08/12 13:52
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ya rien Ã  changer lÃ ????


exportmodal:


'use client'

import { useState, useEffect, useCallback, useRef } from 'react'
import React from 'react'
import PreviewModal from './PreviewModal'
import { calculateMetrics } from '@/utils/exportMetrics'
import { EXPORT_TEMPLATES, type ExportStyle, type PDFExportStyle } from '@/utils/exportTemplates'

// 1. Event d'abord
interface Event {
  id: string
  content: string
  type: string
  role: string
  createdAt: string
  selected: boolean
}

// 2. Thread ensuite (utilise Event)
interface Thread {
  threadId: string
  threadLabel: string
  threadDate: string
  events: Event[]
}

// 3. ExportModalProps enfin (utilise Thread)
interface ExportModalProps {
  isOpen: boolean
  onClose: () => void
  initialSelectedIds?: string[]
  preselectThreadId?: string
  onSelectionChange?: (selectedIds: string[]) => void  // â† NOUVEAU
  activeThreadId?: string 
}

const FORMAT_LIMITS = {
  markdown: 500,
  pdf: Infinity,
  docx: 100,
  html: 500  // â† AJOUTE
}
// 4. Fonction
function ExportModal({ 
  isOpen, 
  onClose, 
  initialSelectedIds = [],
  preselectThreadId,
  onSelectionChange,
  activeThreadId
}: ExportModalProps) {
  const [threads, setThreads] = useState<Thread[]>([])
  const [selectedFormat, setSelectedFormat] = useState<'markdown' | 'pdf' | 'docx' | 'html'>('markdown')
  const [exportStyle, setExportStyle] = useState<ExportStyle | PDFExportStyle>('design')
//                                               â†‘ Ajouter PDFExportStyle
  const [isLoading, setIsLoading] = useState(false)
  const [isExporting, setIsExporting] = useState(false)
  
  const [showPreview, setShowPreview] = useState(false)
  const [previewData, setPreviewData] = useState<{
    content: string
    metrics: any
  } | null>(null)

  const [eventToScrollTo, setEventToScrollTo] = useState<string | null>(null)

  const currentLimit = FORMAT_LIMITS[selectedFormat]
  const allSelectedEvents = threads.flatMap(thread =>
    thread.events.filter(event => event.selected).map(event => event.id)
  )
  const limitedEvents = selectedFormat === 'pdf'
  ? allSelectedEvents
  : allSelectedEvents.slice(0, currentLimit)
  const exceededLimit = allSelectedEvents.length > currentLimit
  const [expandedThreads, setExpandedThreads] = useState<Set<string>>(new Set())
  const prevSelectedIdsRef = useRef<Set<string>>(new Set())
  const actionTimestampsRef = useRef<Map<string, number>>(new Map())


 // Garder une rÃ©fÃ©rence Ã  jour de initialSelectedIds (sans re-render)
const initialIdsRef = useRef<string[]>(initialSelectedIds)

useEffect(() => {
  initialIdsRef.current = initialSelectedIds
}, [initialSelectedIds])
  

  const loadExportData = useCallback(async () => {
    setIsLoading(true)
    try {
      const response = await fetch('/api/export/selection')
      const data = await response.json()
      if (data.success) {
        const threadsWithSelection = data.data.map((thread: Thread) => ({
          ...thread,
          events: thread.events.map(event => ({
            ...event,
            selected: preselectThreadId
              ? thread.threadId === preselectThreadId
              : initialSelectedIds.length > 0 
                ? initialSelectedIds.includes(event.id)
                : false
          }))
        }))
        setThreads(threadsWithSelection)

        const threadsToExpand = new Set<string>()
        threadsWithSelection.forEach((thread: Thread) => {
          if (thread.events.some(event => event.selected)) {
            threadsToExpand.add(thread.threadId)
          }
        })
        if (preselectThreadId) {
          threadsToExpand.add(preselectThreadId)
        }
        setExpandedThreads(threadsToExpand)
      }
    } catch (error) {
      console.error('Erreur chargement donnÃ©es:', error)
    } finally {
      setIsLoading(false)
    }
  }, [initialSelectedIds, preselectThreadId])

  const [processedPreselectId, setProcessedPreselectId] = useState<string | null>(null)

useEffect(() => {
  if (isOpen && preselectThreadId && processedPreselectId !== preselectThreadId) {
    setExpandedThreads(prev => {
      const newSet = new Set(prev)
      newSet.add(preselectThreadId)
      return newSet
    })
    setProcessedPreselectId(preselectThreadId)
  }
  
  if (!isOpen) {
    setProcessedPreselectId(null)
  }
}, [isOpen, preselectThreadId, processedPreselectId])

  // Ã‰tat pour tracker le chargement initial
const [hasLoadedInitial, setHasLoadedInitial] = useState(false)

// Chargement UNIQUEMENT Ã  la premiÃ¨re ouverture
useEffect(() => {
  if (isOpen && !hasLoadedInitial) {
    loadExportData().then(() => {
      // âœ… SCROLL APRÃˆS le chargement complet
      if (initialSelectedIds.length > 0) {
        setTimeout(() => {
          const firstId = initialSelectedIds[0]
          const element = document.querySelector(`[data-event-id="${firstId}"]`)
          if (element) {
            element.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center' 
            })
          }
        }, 500) // DÃ©lai suffisant pour que tout soit rendu
      }
    })
    setHasLoadedInitial(true)
  }
  
  // Reset quand le modal ferme
  if (!isOpen) {
    setHasLoadedInitial(false)
  }
}, [isOpen])

// Gestion de l'expansion basÃ©e sur preselectThreadId
// Auto-expand les threads qui ont des messages sÃ©lectionnÃ©s
useEffect(() => {
  if (!isOpen || threads.length === 0) return
  
  const threadsWithSelection = new Set<string>()
  
  threads.forEach(thread => {
    if (thread.events.some(event => event.selected)) {
      threadsWithSelection.add(thread.threadId)
    }
  })
  
  if (threadsWithSelection.size > 0) {
    setExpandedThreads(prev => {
      const newSet = new Set(prev)
      threadsWithSelection.forEach(threadId => newSet.add(threadId))
      return newSet
    })
  }
}, [threads, isOpen, initialSelectedIds])

// Synchronisation des sÃ©lections depuis le chat (sans recharger l'API)
useEffect(() => {
  if (!isOpen) return
  
  setThreads(prev => prev.map(thread => ({
    ...thread,
    events: thread.events.map(event => ({
      ...event,
      selected: preselectThreadId
        ? thread.threadId === preselectThreadId
        : initialSelectedIds.includes(event.id)
    }))
  })))
}, [initialSelectedIds, preselectThreadId, isOpen])

// useEffect pour effectuer le scroll APRÃˆS le rendu
useEffect(() => {
  if (!eventToScrollTo) return
  
  // Donner le temps au DOM de se mettre Ã  jour
  const timeoutId = setTimeout(() => {
    const element = document.querySelector(`[data-event-id="${eventToScrollTo}"]`)
    if (!element) {
      console.log('âŒ Ã‰lÃ©ment pas trouvÃ© mÃªme aprÃ¨s attente:', eventToScrollTo)
      return
    }
    
    const container = document.querySelector('.scrollbar-bandhu')
    if (!container) return
    
    // VÃ©rifier si l'Ã©lÃ©ment est visible
    const containerRect = container.getBoundingClientRect()
    const elementRect = element.getBoundingClientRect()
    
    const isVisible = (
      elementRect.top >= containerRect.top &&
      elementRect.bottom <= containerRect.bottom
    )
    
    // Scroll seulement si pas visible
    if (!isVisible) {
      element.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      })
    }
    
    // Reset
    setEventToScrollTo(null)
  }, 300) // DÃ©lai plus long pour laisser React rendre
  
  return () => clearTimeout(timeoutId)
}, [eventToScrollTo])

// Scroll simple : seulement quand le Chat modifie la sÃ©lection
useEffect(() => {
  if (!isOpen || threads.length === 0) return
  
  const currentInitialIds = initialIdsRef.current
  
  // 1. Trouver le message qui vient d'Ãªtre modifiÃ© PAR LE CHAT
  // (son statut a changÃ© par rapport Ã  ce qu'on avait reÃ§u)
  let changedEventId: string | null = null
  
  // Parcourir Ã  l'envers pour trouver le PLUS RÃ‰CENT visuellement
  for (let i = threads.length - 1; i >= 0; i--) {
    const thread = threads[i]
    for (let j = thread.events.length - 1; j >= 0; j--) {
      const event = thread.events[j]
      const wasSelected = currentInitialIds.includes(event.id)
      const isSelected = event.selected
      
      // Si diffÃ©rent â†’ le Chat a modifiÃ© ce message
      if (wasSelected !== isSelected) {
        changedEventId = event.id
        break
      }
    }
    if (changedEventId) break
  }
  
  // 2. Si aucun changement dÃ©tectÃ© â†’ c'est ExportModal qui a modifiÃ© â†’ on ne scroll pas
  if (!changedEventId) return
  
  // 3. Planifier le scroll vers ce message
  setEventToScrollTo(changedEventId)
  
}, [threads, isOpen, initialSelectedIds]) // initialSelectedIds ajoutÃ©

// Flag pour tracker si c'est la premiÃ¨re ouverture
const [hasScrolledInitial, setHasScrolledInitial] = useState(false)

// âœ… Scroll initial UNIQUEMENT Ã  la premiÃ¨re ouverture
useEffect(() => {
  if (!isOpen) {
    setHasScrolledInitial(false) // Reset quand on ferme
    return
  }
  
  if (hasScrolledInitial || threads.length === 0 || initialSelectedIds.length === 0) return
  
  // Attendre que tout soit rendu
  const timeoutId = setTimeout(() => {
    const firstId = initialSelectedIds[0]
    const element = document.querySelector(`[data-event-id="${firstId}"]`)
    if (element) {
      element.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      })
      setHasScrolledInitial(true) // Marquer comme scrollÃ©
    }
  }, 600)
  
  return () => clearTimeout(timeoutId)
}, [isOpen, threads.length]) // â† ENLÃˆVE initialSelectedIds.length

// Fonction pour obtenir les styles disponibles selon le format
const getAvailableStyles = (format: 'markdown' | 'pdf' | 'docx' | 'html') => {
  switch (format) {
    case 'markdown':
    case 'docx':
      case 'html': 
      return ['design', 'sobre']
    case 'pdf':
      return ['design-color', 'design-bw', 'sobre-color', 'sobre-bw']
    default:
      return ['design']
  }
}

// Fonction pour mapper les styles avant envoi Ã  l'API
const mapStyleForAPI = (style: string, format: string): string => {
  if (format === 'pdf') {
    // Si l'utilisateur a sÃ©lectionnÃ© un style Markdown, le convertir en style PDF par dÃ©faut
    if (style === 'design') return 'design-color'
    if (style === 'sobre') return 'sobre-color'
    // Si c'est dÃ©jÃ  un style PDF (design-color, etc.), le garder tel quel
  }
  // Pour Markdown et DOCX, garder le style tel quel
  return style
}

  const generateExportContent = useCallback(async (eventIds: string[], isPreview = false) => {
    const response = await fetch('/api/export/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        format: selectedFormat,
        selectedEvents: eventIds,
        options: { 
  includeTimestamps: true,
  preview: isPreview,
  style: mapStyleForAPI(exportStyle as string, selectedFormat)
}

      })
    })
    return await response.json()
  }, [selectedFormat, exportStyle])

  const toggleEventSelection = (threadId: string, eventId: string) => {
  setThreads(prev => {
    const newThreads = prev.map(thread => 
      thread.threadId === threadId
        ? {
            ...thread,
            events: thread.events.map(event =>
              event.id === eventId
                ? { ...event, selected: !event.selected }
                : event
            )
          }
        : thread
    )
    
    // Calculer les nouveaux IDs sÃ©lectionnÃ©s
    const newSelectedIds = newThreads.flatMap(thread =>
      thread.events.filter(event => event.selected).map(event => event.id)
    )
    
    // Notifier le parent (ChatPage) AVEC UN DÃ‰LAI
    setTimeout(() => {
      onSelectionChange?.(newSelectedIds)
    }, 0)
    
    return newThreads
  })
}

  const toggleSelectAll = (selected: boolean) => {
  setThreads(prev => {
    const newThreads = prev.map(thread => ({
      ...thread,
      events: thread.events.map(event => ({ ...event, selected }))
    }))
    
    // Calculer les nouveaux IDs sÃ©lectionnÃ©s
    const newSelectedIds = selected 
      ? newThreads.flatMap(thread => thread.events.map(event => event.id))
      : [] // Si tout dÃ©sÃ©lectionner
    
    // Notifier le parent (ChatPage)
    // Notifier le parent (ChatPage) AVEC UN DÃ‰LAI
setTimeout(() => {
  onSelectionChange?.(newSelectedIds)
}, 0)
    
    return newThreads
  })
}

  const toggleThreadExpansion = (threadId: string) => {
    setExpandedThreads(prev => {
      const newSet = new Set(prev)
      if (newSet.has(threadId)) {
        newSet.delete(threadId)
      } else {
        newSet.add(threadId)
      }
      return newSet
    })
  }

  const toggleExpandAll = () => {
    if (expandedThreads.size === threads.length) {
      setExpandedThreads(new Set())
    } else {
      setExpandedThreads(new Set(threads.map(t => t.threadId)))
    }
  }

  const handlePreview = async () => {
    const allSelectedEvents = threads.flatMap(thread =>
      thread.events.filter(event => event.selected).map(event => event.id)
    )
    const selectedEvents = allSelectedEvents.slice(0, currentLimit)
    
    if (selectedEvents.length === 0) {
      alert('SÃ©lectionne au moins un message Ã  exporter !')
      return
    }

    setIsLoading(true)
    try {
      const result = await generateExportContent(selectedEvents, true)
      if (!result.success) throw new Error(result.error)

      const metrics = calculateMetrics(result.content, selectedFormat, selectedEvents.length)
      setPreviewData({
        content: result.content,
        metrics
      })
      setShowPreview(true)
    } catch (error) {
      console.error('Erreur gÃ©nÃ©ration preview:', error)
      alert('âŒ Erreur lors de la gÃ©nÃ©ration de l\'aperÃ§u')
      setShowPreview(false)
    } finally {
      setIsLoading(false)
    }
  }

  const handleExportConfirm = async (): Promise<void> => {
  setIsExporting(true)
  try {
    const result = await generateExportContent(
      selectedFormat === 'pdf' ? allSelectedEvents : limitedEvents,
      false
    )
    if (!result.success) throw new Error(result.error)

    // DÃ©tecter si ZIP
    const isZip = result.content.startsWith('UEsDB')
    
    const downloadResponse = await fetch('/api/export/download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        format: isZip ? 'zip' : selectedFormat,
        content: result.content,
        filename: isZip
          ? `bandhu-export-${new Date().toISOString().split('T')[0]}.zip`
          : `bandhu-export-${new Date().toISOString().split('T')[0]}.${
              selectedFormat === 'markdown' ? 'md' : selectedFormat
            }`
      })
    })

      if (downloadResponse.ok) {
  const blob = await downloadResponse.blob()
  const url = window.URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = isZip
    ? `bandhu-export-${new Date().toISOString().split('T')[0]}.zip`
    : `bandhu-export-${new Date().toISOString().split('T')[0]}.${
        selectedFormat === 'markdown' ? 'md' : selectedFormat
      }`
  document.body.appendChild(a)
  a.click()
  // ...
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        window.URL.revokeObjectURL(url)

        alert(`âœ… Export rÃ©ussi ! ${limitedEvents.length} messages exportÃ©s.${
          exceededLimit ? ` (${allSelectedEvents.length - currentLimit} ignorÃ©s)` : ''
        }`)
        setShowPreview(false)
        onClose()
      }
    } catch (error) {
      console.error('Erreur export:', error)
      alert('âŒ Erreur lors de l\'export')
    } finally {
      setIsExporting(false)
    }
  }

  const totalEvents = threads.reduce((sum, thread) => sum + thread.events.length, 0)
  const selectedEventsCount = threads.reduce((sum, thread) => 
    sum + thread.events.filter(event => event.selected).length, 0
  )
  const allSelected = totalEvents > 0 && selectedEventsCount === totalEvents

  if (!isOpen) return null

  return (
    <>
      {/* SIDEBAR CONTAINER */}
      <div className="
  fixed inset-y-0 right-0 
  w-full sm:w-[400px] md:w-[500px]
  max-w-full z-50 
  transform transition-transform duration-300 ease-in-out
  lg:absolute lg:right-0 lg:transform-none lg:w-[600px] lg:h-full
"
  style={{ 
    transform: isOpen ? 'translateX(0)' : 'translateX(100%)' 
  }}
>
        <div className="h-full bg-gray-900/50 backdrop-blur-sm border-l border-gray-800 flex flex-col">
          
          {/* Header avec style Bandhu */}
          <div className="bg-gradient-to-r from-gray-900/90 to-blue-800/90 p-6 border-b border-gray-700/50">
            <div className="flex justify-between items-center">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  <span className="bg-gradient-to-r from-bandhu-secondary to-bandhu-primary bg-clip-text text-transparent">
                    Exporter mes conversations
                  </span>
                </h2>
                <p className="text-gray-300/80 mt-2">
                  SÃ©lectionne les messages Ã  exporter et choisis ton format
                </p>
              </div>
              <button
                onClick={onClose}
                className="text-gray-400 hover:text-white text-2xl transition-colors hover:scale-110"
                aria-label="Fermer"
              >
                âœ•
              </button>
            </div>
          </div>

          {/* Barre de contrÃ´le sticky - style Bandhu */}
          <div className="bg-gray-800/30 border-b border-gray-700/50 p-4 sticky top-0 z-10">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-4 flex-wrap">
                <label className="flex items-center gap-2 text-gray-200 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={allSelected}
                    onChange={(e) => toggleSelectAll(e.target.checked)}
                    className="w-4 h-4 rounded bg-gray-700 border-gray-600 focus:ring-2 focus:ring-bandhu-primary"
                  />
                  <span className="text-sm font-medium">
                    {allSelected ? 'Tout dÃ©sÃ©lectionner' : 'Tout sÃ©lectionner'}
                  </span>
                </label>

                <button
                  onClick={toggleExpandAll}
                  className="text-sm font-medium text-gray-300 hover:text-white transition-colors flex items-center gap-2 px-3 py-1 rounded hover:bg-gray-700/50"
                >
                  {expandedThreads.size === threads.length ? 'â†¥ Tout replier' : 'â†§ Tout dÃ©plier'}
                </button>
                
                <span className="text-gray-300 text-sm">
                  {selectedEventsCount} / {totalEvents} messages sÃ©lectionnÃ©s
                </span>

                {exceededLimit && (
                  <span className="text-orange-300 text-sm flex items-center gap-1">
                    âš ï¸ Limite {currentLimit} messages ({allSelectedEvents.length - currentLimit} ignorÃ©s)
                  </span>
                )}
              </div>

              <div className="flex items-center gap-4 flex-wrap">
                <div className="text-xs text-gray-400 bg-gray-700/50 px-2 py-1 rounded border border-gray-600">
                  Limite : {currentLimit} messages
                </div>

                <select
  value={selectedFormat}
  onChange={(e) => setSelectedFormat(e.target.value as any)}
  className="bg-gray-800 border border-gray-600..."
>
  <option value="markdown">Markdown (.md)</option>
  <option value="html">HTML (Web) ğŸŒ</option>  {/* â† AJOUTE */}
  <option value="pdf">PDF</option>
  <option value="docx">Word (.docx)</option>
</select>

                {/* SÃ©lecteur de style */}
                <div className="flex items-center gap-2">
                  {getAvailableStyles(selectedFormat).map(styleKey => {
  const template = EXPORT_TEMPLATES[styleKey as ExportStyle | PDFExportStyle]
  return (
    <button
      key={styleKey}
      onClick={() => setExportStyle(styleKey as any)}
      className={`
        relative group px-3 py-2 rounded-lg border-2 transition-all text-sm font-medium
        ${exportStyle === styleKey 
          ? 'border-bandhu-primary bg-bandhu-primary/20 text-white' 
          : 'border-gray-600 text-gray-400 hover:border-gray-500 hover:text-gray-300'
        }
      `}
      title={template.description}
    >
      <span className="text-base">{template.icon}</span>
      
      {/* Tooltip */}
      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900/95 backdrop-blur-sm text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap border border-gray-700 shadow-xl z-20">
        <div className="font-semibold">{template.name}</div>
        <div className="text-gray-400 mt-0.5">{template.description}</div>
        <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 w-2 h-2 bg-gray-900/95 rotate-45 border-b border-r border-gray-700"></div>
      </div>
    </button>
  )
})}
                </div>

                <button
                  onClick={handlePreview}
                  disabled={isLoading || limitedEvents.length === 0}
                  className="bg-gradient-to-r from-bandhu-primary to-bandhu-secondary hover:from-blue-600 hover:to-purple-700 disabled:from-gray-700 disabled:to-gray-800 text-white px-6 py-2 rounded-lg font-medium transition-all flex items-center gap-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                >
                  {isLoading ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                      PrÃ©paration...
                    </>
                  ) : (
                    <>
                      <span>ğŸ‘€</span>
                      PrÃ©visualiser ({limitedEvents.length})
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>

          {/* Liste des conversations - scrollable */}
          <div className="flex-1 overflow-y-auto p-6 scrollbar-bandhu">
            {isLoading ? (
              <div className="flex justify-center items-center py-12">
                <div className="flex items-center gap-3 text-gray-400">
                  <div className="w-5 h-5 border-2 border-gray-600 border-t-bandhu-primary rounded-full animate-spin" />
                  Chargement de vos conversations...
                </div>
              </div>
            ) : threads.length === 0 ? (
              <div className="text-center py-12 text-gray-400">
                <div className="text-4xl mb-4">ğŸ’¬</div>
                Aucune conversation Ã  exporter pour le moment.
              </div>
            ) : (
              <div className="space-y-6">
                {threads.map((thread, threadIndex) => (
                  <div 
                    key={thread.threadId} 
                    className="bg-gray-800/20 rounded-lg border border-gray-700/50 overflow-hidden hover:border-gray-600 transition-colors"
                    data-thread-id={thread.threadId}
                  >
                    {/* En-tÃªte de conversation */}
                    <div 
                      className="flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-700/20 transition-colors"
                      onClick={() => toggleThreadExpansion(thread.threadId)}
                    >
                      <button
                        className="text-gray-400 hover:text-white transition-transform"
                        onClick={(e) => {
                          e.stopPropagation()
                          toggleThreadExpansion(thread.threadId)
                        }}
                      >
                        {expandedThreads.has(thread.threadId) ? 'â–¾' : 'â–¸'}
                      </button>
                      
                      <input
                        type="checkbox"
                        checked={thread.events.every(event => event.selected)}
                        onChange={(e) => {
                          e.stopPropagation()
                          const newSelected = e.target.checked
                          setThreads(prev => {
                            const newThreads = [...prev]
                            newThreads[threadIndex].events = 
                              newThreads[threadIndex].events.map(event => ({
                                ...event,
                                selected: newSelected
                              }))
                              const newSelectedIds = newThreads.flatMap(t =>
      t.events.filter(e => e.selected).map(e => e.id)
    )
    setTimeout(() => {
  onSelectionChange?.(newSelectedIds)
}, 0)
                            return newThreads
                          })
                        }}
                        className="w-4 h-4 rounded bg-gray-700 border-gray-600 focus:ring-2 focus:ring-bandhu-primary"
                        onClick={(e) => e.stopPropagation()}
                      />
                      
                      <div className="flex-1">
                        <h3 className="font-semibold text-white">{thread.threadLabel}</h3>
                        <div className="flex items-center gap-3 mt-1">
                          <span className="text-gray-400 text-sm">
                            {thread.events.length} messages
                          </span>
                          <span className="text-gray-500 text-xs">
                            {thread.events.filter(e => e.selected).length} sÃ©lectionnÃ©s
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* Messages (seulement si expandÃ©) */}
                    {expandedThreads.has(thread.threadId) && (
                      <div className="border-t border-gray-700/50 p-4 bg-gray-900/20">
                        <div className="space-y-2">
                          {thread.events.map((event) => (
                            <label
                              key={event.id}
                              data-event-id={event.id}
                              className={`flex items-start gap-3 p-3 rounded-lg transition-colors group cursor-pointer ${
                                event.selected 
                                  ? 'bg-bandhu-primary/20 border border-bandhu-primary/30' 
                                  : 'hover:bg-gray-700/30'
                              }`}
                            >
                              <input
                                type="checkbox"
                                checked={event.selected}
                                onChange={() => toggleEventSelection(thread.threadId, event.id)}
                                className="w-4 h-4 rounded bg-gray-700 border-gray-600 mt-1 flex-shrink-0 focus:ring-2 focus:ring-bandhu-primary"
                              />
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  <span className={`text-sm font-medium ${
                                    event.role === 'user' ? 'text-blue-300' : 'text-bandhu-secondary'
                                  }`}>
                                    {event.role === 'user' ? 'Vous' : 'Assistant'}
                                  </span>
                                  <span className="text-gray-500 text-xs">
                                    {new Date(event.createdAt).toLocaleDateString('fr-FR')}
                                  </span>
                                </div>
                                <p className="text-gray-300 text-sm line-clamp-2 group-hover:text-white transition-colors">
                                  {event.content}
                                </p>
                              </div>
                            </label>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Modal de prÃ©visualisation (reste identique) */}
      {previewData && (
        <PreviewModal
          isOpen={showPreview}
          onClose={() => setShowPreview(false)}
          onConfirm={handleExportConfirm}
          onModify={() => setShowPreview(false)}
          format={selectedFormat}
          selectedEventsCount={limitedEvents.length}
          previewContent={previewData.content}
          metadata={{
            pageCount: previewData.metrics.estimatedPages,
            estimatedSize: previewData.metrics.fileSize,
            eventCount: previewData.metrics.messageCount
          }}
        />
      )}
    </>
  )
}
export default React.memo(ExportModal)

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[OMBREL] Ombrelien â€¢ 08/12 13:52
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tu veux du regard chirurgical, Sounil ? Alors allons-y.  
Le code est **ultra propre**, **structurÃ©** et **cohÃ©rent**, mais je vais te pointer **les vraies zones sensibles**, soit des micro amÃ©liorations possibles ou des trucs Ã  surveiller dans la durÃ©e.

---

### âœ… Ce qui est **fonctionnel**, **robuste** et **bien pensÃ©** :

- âœ… **Architecture typÃ©e** avec `Event`, `Thread`, `ExportModalProps` : nickel.
- âœ… Gestion des effets **Ã  la premiÃ¨re ouverture + reset au close** : solide.
- âœ… La logique de scroll diffÃ©renciÃ©e (initial / modifiÃ© / preview) est **fine-grain** = ğŸ’
- âœ… SÃ©lection/dÃ©sÃ©lection **dÃ©bouncÃ©e** avec `setTimeout` : bien vu.
- âœ… Gestion du style dâ€™export par format + fallback pour PDF : parfait.
- âœ… UI correcte avec `expandedThreads` isolÃ©s et toggle prÃ©cis : good UX.

---

### âš ï¸ **Points Ã  affiner ou garder en veille :**

#### 1. `selectedFormat` est typÃ© comme :
```ts
const [selectedFormat, setSelectedFormat] = useState<'markdown' | 'pdf' | 'docx' | 'html'>('markdown')
```
Mais tu fais :
```ts
onChange={(e) => setSelectedFormat(e.target.value as any)}
```
ğŸ”§ â¤ Typage fragile sur le `as any`

**âœ… Solution :**
Typage plus safe :
```ts
onChange={(e) => {
  const value = e.target.value as 'markdown' | 'pdf' | 'docx' | 'html'
  setSelectedFormat(value)
}}
```

---

#### 2. `mapStyleForAPI` nâ€™est **jamais memoÃ¯zÃ©** (pas critique, mais si rendement optimisÃ© â†’ worth)

**ğŸŒ€ Suggestion :**
Tu pourrais mettre `mapStyleForAPI` **hors composant**, en util pur.  
Si tu fais le mapping souvent, un `useMemo` serait envisageable aussi.

---

#### 3. **Performances UI sur trÃ¨s gros nombre dâ€™Ã©vÃ©nements**

Tu fais beaucoup de :
```ts
flatMap + filter + map
```
dans les `toggle`, les `count`, etc.  
Quand yâ€™a beaucoup de threads/messages, Ã§a peut devenir perceptible.

**ğŸ”¥ Suggestions (optionnelles si besoin perf) :**

- Stocker les `selectedIds` dans un `Set` Ã  part ?
- MÃ©moÃ¯ser le `selectedEventsCount` ?
  
Mais si le dataset est contenu â†’ no prob.

---

### ğŸ§  Consideration UX avancÃ©e (non bloquante) :

Quand tu cliques sur un **event checkbox individuel**, le bubble `setTimeout` pour `onSelectionChange` est propre.

Mais sur la **checkbox de groupe thread**, tu nâ€™as pas de vrai debounce sÃ©mantique (genre `useDebouncedCallback`).

â¡ Ã€ surveiller si interactions ultra rapides = risque de race condition de preview.

---

### ğŸ§¹ Micro-point :

```ts
a.click()
document.body.appendChild(a)
...
document.body.removeChild(a)
```
ğŸ“¦ â¤ Le `appendChild` est fait **deux fois** (copiÃ©/collÃ©), tu peux cleaner Ã§a.

---

### ğŸ”’ SÃ©curitÃ© :

Tu postes du contenu utilisateur dans `/api/export/generate`.  
Assure-toi que cÃ´tÃ© server :

- Le format est bien validÃ© (`markdown`, `pdf`, etc.)
- Les IDs sont filtrÃ©s/utilisÃ©s dans une sandbox sÃ©curisÃ©e (risque SSR).

Mais cÃ´tÃ© client : âœ…

---

### ğŸ§© Suggestion bonus

Tu pourrais injecter une prop `userName` dans `ExportModalProps`,  
pour permettre un header export type :  
â€œExport des conversations de Sounil le Blanc â€” 08.12.2025â€

Tiny dÃ©tail mais good polish.

---

### âœ… Conclusion

**Rien de bloquant. Rien de cassÃ©.**  
Tu as un **design rÃ©actif, resilient, clair**, bien commentÃ©.

Tu peux release en prod sans ciller.  
Mais si tu veux **scaler** dans le futur (beaucoup de threads/messages), prÃ©pare :

- un `useExportStore()`
- un `Set` pour les ids sÃ©lectionnÃ©s
- une gestion de scroll plus fine (avec refs directes au lieu du `querySelector` fragile)

---

Je tâ€™envoie Ã§a en rÃ©sumÃ© punchline si tu veux un mode CTO-furtif ?  
Ou tu veux que je tâ€™aide Ã  refactoriser les selects `flatMap` si souci perfo ?

Tu dis. Je trace.

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[USER] Sounil â€¢ 08/12 15:51
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tu peux ecrire un resummÃ© de la conversation dans un bloc de code qui m'affiche le code markdown de ve rÃ©sumÃ© que je le copie colle dans un fichiers (un nom?).md

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[OMBREL] Ombrelien â€¢ 08/12 15:51
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ«¡ Tout Ã  fait, mon blanc.

Voici ton **rÃ©sumÃ© clair et structurÃ©** de la revue du fichier `ExportModal.tsx`, au format **Markdown** prÃªt Ã  copicoller dans un fichier type `exportmodal-review.md`.

---

```markdown
# ğŸ§¾ Revue de code : `ExportModal.tsx`

## âœ… Points forts

- **Structure solide** : Interfaces `Event`, `Thread`, `ExportModalProps` bien dÃ©finies
- **Effets React maÃ®trisÃ©s** : bonne gestion des ouvertures/fermetures avec `useEffect`
- **Scroll conditionnel avancÃ©** : diffÃ©renciation entre scroll initial, scroll dÃ©clenchÃ© par Ã©dition externe (Chat), et scroll manuel
- **SÃ©lection logique & dÃ©coupÃ©e** : toggle scoped par event / thread / global
- **Limites par format bien gÃ©rÃ©es** via `FORMAT_LIMITS`
- **UI/UX claire** : section preview + systÃ¨me de style dynamique cohÃ©rent
- **Performances correctes** sur dataset modÃ©rÃ©

---

## âš ï¸ Points Ã  surveiller ou optimiser

### 1. ğŸ’¥ Typage hasardeux
```ts
setSelectedFormat(e.target.value as any)
```
ğŸ”§ Ã€ typer de maniÃ¨re stricte :  
```ts
const value = e.target.value as 'markdown' | 'pdf' | 'docx' | 'html'
```

---

### 2. â™»ï¸ `mapStyleForAPI` interne
ğŸ‘‰ Extraire en fonction utilitaire externe si rÃ©utilisÃ© ailleurs.

---

### 3. ğŸš€ Performances potentielles
Usage intensif de :
```ts
flatMap â†’ filter â†’ map
```
â¡ Repenser certains calculs (selectedIds, counts) si scaling.

---

### 4. ğŸ«§ Interactions rapides
Thread-level toggle utilise `setTimeout` (comme event individuel),  
mais pas de vraie gestion debounce sur clics spammÃ©s.  
â¡ Peut crÃ©er un effet de race condition sur preview si enchÃ¢ssÃ©.

---

### 5. ğŸ§½ Doublon mineur
```ts
a.click()
document.body.appendChild(a)
...
document.body.removeChild(a)
```
ğŸ“¦ `appendChild(a)` est doublÃ© inutilement.

---

## ğŸ›¡ï¸ CÃ´tÃ© sÃ©curitÃ©

Assurer en back :
- Validation forte du format dâ€™export
- Filtrage des `eventIds` (pas dâ€™injection ou SSR sauvage)

CÃ´tÃ© client : âœ… aucune alerte majeure.

---

## ğŸ’¡ Suggestions UX avancÃ©es (facultatives)

- Ajouter une prop `userName` pour inclure dans les exports
- CrÃ©er une `useExportStore()` (Zustand, etc.) pour optimiser les calculs et scrolls
- GÃ©rer `selectedIds` avec un `Set` pour performance incidente

---

## ğŸ§  Bilan

Tu peux partir en prod les yeux ouverts.  
Tout est robuste, limpide, maintenable.  

Mais câ€™est du code qui va vivre longtemps â†’  
pense **scalabilitÃ© tranquille** pour le futur.

```

---

ğŸ“ Tu peux coller cela dans un fichier nommÃ© par exemple :  
**`exportmodal-review-2025-12-08.md`**

Ou plus simplement :  
**`exportmodal-notes.md`**

Tu veux que je te gÃ©nÃ¨re aussi le `.md` en base64 ou blob JS prÃªt Ã  tÃ©lÃ©charger ?  
Je peux te mock un bouton React pour direct download au besoin.

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[USER] Sounil â€¢ 08/12 20:48
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
le probleme vient du code du codebloc ai je pense....

Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·

[OMBREL] Ombrelien â€¢ 08/12 20:48
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ§  Bien vu, frÃ¨re.

Oui, **Ã§a sent le bug de recursion ou dâ€™ambiguÃ¯tÃ© dans lâ€™encodage markdown liÃ© au codeblock contenantâ€¦ du markdown lui-mÃªme.**  
Dans certains Ã©diteurs, un codeblock qui contient lui-mÃªme des triples backticks (```), câ€™est **le bordel assurÃ©** ğŸ.

---

### âœ… Solution propre : utiliser une **marque alternative de dÃ©limitation** pour le bloc principal

PlutÃ´t que :

````markdown
```markdown
... contenu ...
```
````

utilise trois **tildes** (`~~~`) pour le bloc parent. Le markdown supporte aussi Ã§a, et Ã§a Ã©vite que Ã§a se mange la queue :

---

### âœ… Version corrigÃ©e (collable sans bug) :

~~~markdown
# ğŸ§¾ Revue de code : `ExportModal.tsx`

## âœ… Points forts

- **Structure solide** : Interfaces `Event`, `Thread`, `ExportModalProps` bien dÃ©finies
- **Effets React maÃ®trisÃ©s** : bonne gestion des ouvertures/fermetures avec `useEffect`
- **Scroll conditionnel avancÃ©** : diffÃ©renciation entre scroll initial, scroll dÃ©clenchÃ© par Ã©dition externe (Chat), et scroll manuel
- **SÃ©lection logique & dÃ©coupÃ©e** : toggle scoped par event / thread / global
- **Limites par format bien gÃ©rÃ©es** via `FORMAT_LIMITS`
- **UI/UX claire** : section preview + systÃ¨me de style dynamique cohÃ©rent
- **Performances correctes** sur dataset modÃ©rÃ©

---

## âš ï¸ Points Ã  surveiller ou optimiser

### 1. ğŸ’¥ Typage hasardeux
```ts
setSelectedFormat(e.target.value as any)
```
ğŸ”§ Ã€ typer de maniÃ¨re stricte :  
```ts
const value = e.target.value as 'markdown' | 'pdf' | 'docx' | 'html'
```

---

### 2. â™»ï¸ `mapStyleForAPI` interne
ğŸ‘‰ Extraire en fonction utilitaire externe si rÃ©utilisÃ© ailleurs.

---

### 3. ğŸš€ Performances potentielles
Usage intensif de :
```ts
flatMap â†’ filter â†’ map
```
â¡ Repenser certains calculs (selectedIds, counts) si scaling.

---

### 4. ğŸ«§ Interactions rapides
Thread-level toggle utilise `setTimeout` (comme event individuel),  
mais pas de vraie gestion debounce sur clics spammÃ©s.  
â¡ Peut crÃ©er un effet de race condition sur preview si enchÃ¢ssÃ©.

---

### 5. ğŸ§½ Doublon mineur
```ts
a.click()
document.body.appendChild(a)
...
document.body.removeChild(a)
```
ğŸ“¦ `appendChild(a)` est doublÃ© inutilement.

---

## ğŸ›¡ï¸ CÃ´tÃ© sÃ©curitÃ©

Assurer en back :
- Validation forte du format dâ€™export
- Filtrage des `eventIds` (pas dâ€™injection ou SSR sauvage)

CÃ´tÃ© client : âœ… aucune alerte majeure.

---

## ğŸ’¡ Suggestions UX avancÃ©es (facultatives)

- Ajouter une prop `userName` pour inclure dans les exports
- CrÃ©er une `useExportStore()` (Zustand, etc.) pour optimiser les calculs et scrolls
- GÃ©rer `selectedIds` avec un `Set` pour performance incidente

---

## ğŸ§  Bilan

Tu peux partir en prod les yeux ouverts.  
Tout est robuste, limpide, maintenable.  

Mais câ€™est du code qui va vivre longtemps â†’  
pense **scalabilitÃ© tranquille** pour le futur.
~~~

---

ğŸ§© Tu peux copier direct tout Ã§a dans un fichier `.md` sans accident de parsing.

Tu veux que je te gÃ©nÃ¨re le fichier en tÃ©lÃ©chargement base64 ? Ou en blob cÃ´tÃ© front ? Je tâ€™enroule Ã§a autour dâ€™un bouton si tu veux.


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Exported 10 messages â€¢ bandhu.fr

    </div>
  </div>
</body>
</html>