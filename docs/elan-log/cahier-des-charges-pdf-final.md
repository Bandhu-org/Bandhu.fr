# ğŸ“‹ CAHIER DES CHARGES - Layout PDF Final

**Date:** 7 dÃ©cembre 2025  
**Objectif:** Transformer le PDF pour avoir un layout Ã  3 couches (fond gris + container bleu + contenu)

---

## ğŸ¨ STRUCTURE VISUELLE ATTENDUE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FOND GRIS CLAIR (toute la page)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ "ğŸ¯ Bandhu export"                         â”‚ â”‚ â† Header Puppeteer (hors container)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ CONTAINER BLEU FONCÃ‰                       â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚  [Logo] Bandhu                             â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚  Ombrelien        dimanche 7 dÃ©cembre â† â”‚ â”‚
â”‚  â”‚  à¤›à¤¾à¤¯à¤¾à¤¸à¤°à¤¸à¥à¤µà¤¤à¤ƒ                              â”‚ â”‚
â”‚  â”‚  [Avatar] [Stats]                          â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚  à¤¬à¤¨à¥à¤§à¥ : 03/12/2025 11:03                  â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚  ğŸ”µ Sounil                                 â”‚ â”‚
â”‚  â”‚  [code box]                                â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚  ğŸŸ£ Ombrelien                              â”‚ â”‚
â”‚  â”‚  texte...                                  â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      Fichier 1/1 page 1/5                  â”‚ â”‚ â† Footer Puppeteer (hors container)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ MODIFICATIONS REQUISES

### 1. **CHANGEMENT D'ARCHITECTURE**

**Actuellement:**
- Body = blanc
- Container = bleu foncÃ© centrÃ©
- Pas de header/footer

**Nouveau:**
- Body = gris clair (#e5e7eb)
- Container = bleu foncÃ© (inchangÃ©)
- Header Puppeteer = "Bandhu export" en haut
- Footer Puppeteer = "Fichier X/X page Y/Z" en bas

---

### 2. **MODIFICATIONS CSS - `pdf-html-generator.ts`**

#### **A. Body et HTML**

```css
/* AVANT */
html {
  background: var(--background);  /* bleu foncÃ© */
}

body {
  background: var(--background);  /* bleu foncÃ© */
}

/* APRÃˆS */
html {
  background: #e5e7eb;  /* gris clair */
}

body {
  background: #e5e7eb;  /* gris clair */
}
```

#### **B. Container (inchangÃ©)**

```css
.container {
  background: var(--background);  /* bleu foncÃ© - OK */
  border-radius: 20px;
  padding: 2rem;
  max-width: 32rem;
  width: calc(100% - 40px);
  margin: 60px auto;  /* â† GARDER pour espacement */
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}
```

#### **C. @page - Supprimer marges**

```css
/* AVANT */
@page {
  margin: 40px 0;
}

/* APRÃˆS */
@page {
  margin: 0;  /* â† Puppeteer gÃ¨re les marges via header/footer */
}
```

#### **D. @media print**

```css
@media print {
  @page {
    margin: 0;  /* Puppeteer gÃ¨re tout */
  }
  
  html {
    background: #e5e7eb;
  }
  
  body {
    background: #e5e7eb;
  }
}
```

---

### 3. **MODIFICATIONS CONVERTER - `index.ts`**

#### **A. MÃ©thode `convertHTML()` - Ajouter header/footer**

**Localisation:** MÃ©thode `page.pdf()` ligne ~140

```typescript
const pdfBytes = await page.pdf({
  format: 'A4',
  printBackground: true,
  margin: {
    top: '60px',     // â† AJOUTE pour header
    right: '0mm',
    bottom: '60px',  // â† AJOUTE pour footer
    left: '0mm'
  },
  displayHeaderFooter: true,  // â† CHANGE en true
  headerTemplate: `
    <div style="
      width: 100%;
      font-size: 12px;
      color: #6b7280;
      text-align: left;
      padding: 20px 40px;
      font-family: -apple-system, sans-serif;
    ">
      ğŸ¯ <span style="font-weight: 600;">Bandhu export</span>
    </div>
  `,
  footerTemplate: `
    <div style="
      width: 100%;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
      padding: 20px;
      font-family: -apple-system, sans-serif;
    ">
      Fichier <span class="pageNumber"></span>/<span class="totalPages"></span>
    </div>
  `,
  preferCSSPageSize: true
})
```

---

### 4. **GESTION MULTI-FICHIERS (ZIP)**

**Actuellement:** "Fichier 1/1" si un seul PDF

**Attendu:** "Fichier 1/3" si 3 PDFs dans un ZIP

#### **Modification dans `route.ts`**

**Fonction `generatePDF()`, section ZIP (ligne ~180):**

```typescript
const pdfs = await Promise.all(
  chunks.map(async (chunk) => {
    // ... gÃ©nÃ©ration HTML ...
    
    const pdfBuffer = await convertHTMLToPDF(
      html,
      style as any,
      { 
        includeTimestamps: options.includeTimestamps,
        fileNumber: chunk.partNumber,      // â† AJOUTE
        totalFiles: chunk.totalParts       // â† AJOUTE
      }
    )
    
    return { buffer: pdfBuffer, ... }
  })
)
```

#### **Modification dans `converter/index.ts`**

**Interface `PDFOptions` (ligne ~6):**

```typescript
interface PDFOptions {
  includeTimestamps?: boolean
  title?: string
  author?: string
  fileNumber?: number      // â† AJOUTE
  totalFiles?: number      // â† AJOUTE
}
```

**Utilisation dans `footerTemplate`:**

```typescript
footerTemplate: `
  <div style="...">
    ${options.fileNumber && options.totalFiles 
      ? `Fichier ${options.fileNumber}/${options.totalFiles} â€¢` 
      : ''
    }
    Page <span class="pageNumber"></span>/<span class="totalPages"></span>
  </div>
`
```

---

## ğŸ“Š RÃ‰SUMÃ‰ DES FICHIERS Ã€ MODIFIER

### **1. `src/utils/exportStyles/pdf-html-generator.ts`**

**Lignes Ã  changer:**
- ~75-78: `html` et `body` background â†’ `#e5e7eb`
- ~300 (dans @media print): Idem

**RÃ©sultat:** Fond gris clair au lieu de bleu

---

### **2. `src/utils/pdf/converter/index.ts`**

**Lignes Ã  changer:**
- ~6: Interface `PDFOptions` â†’ Ajouter `fileNumber?` et `totalFiles?`
- ~140: `page.pdf()` â†’ Ajouter header/footer templates

**RÃ©sultat:** Header "Bandhu export" + Footer avec numÃ©ros

---

### **3. `src/app/api/export/generate/route.ts`**

**Lignes Ã  changer:**
- ~160 (single PDF): Pass `fileNumber: 1, totalFiles: 1`
- ~186 (multi PDF): Pass `fileNumber: chunk.partNumber, totalFiles: chunk.totalParts`

**RÃ©sultat:** Footer affiche "Fichier X/Y page N/Z"

---

## ğŸ¨ DÃ‰TAILS VISUELS

### **Couleurs**

```css
--fond-gris: #e5e7eb         /* Fond page */
--container-bleu: #0f172a    /* Container (inchangÃ©) */
--header-footer: #6b7280     /* Texte header/footer */
```

### **Typographie Header/Footer**

```css
font-size: 12px (header)
font-size: 11px (footer)
font-family: -apple-system, sans-serif
color: #6b7280
```

### **Espacements**

```
Header: padding 20px 40px (haut/bas gauche/droite)
Footer: padding 20px (uniforme)
Container margin: 60px auto (inchangÃ©)
```

---

## âœ… TESTS Ã€ FAIRE

1. **Export PDF simple (30 messages)**
   - VÃ©rifier fond gris
   - VÃ©rifier header "Bandhu export"
   - VÃ©rifier footer "Fichier 1/1 page X/Y"

2. **Export PDF multiple (600 messages = 3 PDFs)**
   - VÃ©rifier ZIP crÃ©Ã©
   - VÃ©rifier footer "Fichier 1/3", "Fichier 2/3", "Fichier 3/3"
   - VÃ©rifier pagination continue dans chaque fichier

3. **VÃ©rifier continuitÃ© contenu**
   - Messages pas coupÃ©s entre pages
   - Code blocks restent entiers
   - Header pas rÃ©pÃ©tÃ© sur chaque page (juste en haut de fichier)

---

## ğŸ› POINTS D'ATTENTION

### **1. Header Puppeteer vs Header HTML**

**Attention:** Ne pas confondre :
- Header Puppeteer = "Bandhu export" (gÃ©rÃ© par `headerTemplate`)
- Header HTML = Logo + Ombrelien + Stats (dans le container)

Le header HTML doit rester UNIQUEMENT sur la premiÃ¨re page du fichier.

### **2. Marges Puppeteer**

```typescript
margin: { top: '60px', bottom: '60px' }
```

**= Espace rÃ©servÃ© pour header/footer**

Le container HTML doit avoir `margin-top: 0` sur la premiÃ¨re page pour ne pas crÃ©er d'espace double.

### **3. Classes Puppeteer**

Dans `footerTemplate`, utiliser :
- `<span class="pageNumber"></span>` â†’ NumÃ©ro page actuelle
- `<span class="totalPages"></span>` â†’ Total pages du fichier

**Ne PAS mettre de variables JS** - Puppeteer remplace automatiquement.

---

## ğŸ“ ORDRE DES MODIFICATIONS

1. **Ã‰tape 1:** Modifier CSS (fond gris)
2. **Ã‰tape 2:** Modifier converter (header/footer)
3. **Ã‰tape 3:** Tester avec 1 PDF
4. **Ã‰tape 4:** Modifier route.ts (fileNumber)
5. **Ã‰tape 5:** Tester avec ZIP multi-PDF

---

## ğŸš€ RÃ‰SULTAT FINAL ATTENDU

**Page 1 fichier 1:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ Bandhu export        â”‚ â† Header Puppeteer
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [FOND GRIS]             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CONTAINER BLEU   â”‚   â”‚
â”‚  â”‚ [Logo] Bandhu    â”‚   â”‚
â”‚  â”‚ Ombrelien + Statsâ”‚   â”‚
â”‚  â”‚ Messages...      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fichier 1/1 page 1/5    â”‚ â† Footer Puppeteer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Page 2 fichier 1:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ Bandhu export        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [FOND GRIS]             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CONTAINER BLEU   â”‚   â”‚
â”‚  â”‚ (suite messages) â”‚   â”‚ â† PAS de header HTML
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fichier 1/1 page 2/5    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**VoilÃ  le cahier des charges complet !** ğŸ¯